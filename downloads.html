<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Downloads</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
        .container { max-width: 600px; margin: 2em auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2em; }
        #session-input { width: 100%; padding: 1em; font-size: 1em; margin-bottom: 1em; border: 2px solid #ddd; border-radius: 6px; }
        #load-btn { width: 100%; padding: 1em; font-size: 1.1em; border-radius: 6px; border: none; background: #0078d4; color: #fff; cursor: pointer; }
        #load-btn:disabled { background: #aaa; }
        #file-list { margin-top: 2em; }
        .file-item { padding: 1em; margin: 0.5em 0; background: #f5f5f5; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .download-btn { padding: 0.5em 1em; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .download-btn:hover { background: #218838; }
        #status { margin-top: 1em; color: #666; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>File Downloads</h1>
        <p>Enter a session ID to view and download files:</p>
        
        <input type="text" id="session-input" placeholder="Enter session ID (e.g., c06606fe-e8e6-4ccb-97d6-c28291878e83)" />
        <button id="load-btn" onclick="loadSession()">Load Session Files</button>
        
    <div id="status"></div>
        <div id="file-list"></div>
    </div>

    <script>
        async function loadSession() {
            const sessionId = document.getElementById('session-input').value.trim();
            const statusDiv = document.getElementById('status');
            const fileListDiv = document.getElementById('file-list');
            const loadBtn = document.getElementById('load-btn');
            
            if (!sessionId) {
                statusDiv.innerHTML = '<p class="error">Please enter a session ID</p>';
                return;
            }
            
            loadBtn.disabled = true;
            statusDiv.innerHTML = '<p>Loading session...</p>';
            fileListDiv.innerHTML = '';
            
            try {
                const response = await fetch(`/${sessionId}/status`);
                if (!response.ok) {
                    throw new Error('Session not found');
                }
                
                const session = await response.json();
                // Show status as a badge above the file list
                let statusBadge = `<div style="display:inline-block;padding:0.3em 1em;border-radius:1em;font-size:1em;font-weight:500;margin-bottom:1em;background:#e3f2fd;color:#1976d2;">Status: ${session.status}</div>`;
                if (session.uploads && session.uploads.length > 0) {
                    const fileItems = session.uploads.map(file => {
                        const ext = file.filename.split('.').pop().toLowerCase();
                        let preview = '';
                        const fileUrl = `/download/${sessionId}/${encodeURIComponent(file.filename)}`;
                        if (["jpg","jpeg","png","gif","webp","bmp"].includes(ext)) {
                            preview = `<img src="${fileUrl}" alt="${file.filename}" style="max-width:100px;max-height:100px;border-radius:4px;margin-right:10px;" />`;
                        } else if (["pdf"].includes(ext)) {
                            preview = `<embed src="${fileUrl}" type="application/pdf" width="100" height="100" style="border-radius:4px;margin-right:10px;" />`;
                        } else if (["mp4","webm","ogg"].includes(ext)) {
                            preview = `<video src="${fileUrl}" controls width="100" height="70" style="border-radius:4px;margin-right:10px;"></video>`;
                        } else if (["txt","md","csv","json"].includes(ext)) {
                            preview = `<iframe src="${fileUrl}" width="100" height="70" style="border-radius:4px;margin-right:10px;"></iframe>`;
                        } else if (["doc","docx","ppt","pptx","xls","xlsx"].includes(ext)) {
                            preview = `<span style="display:inline-block;width:100px;height:70px;background:#eee;border-radius:4px;margin-right:10px;text-align:center;line-height:70px;font-size:12px;">${ext.toUpperCase()} Preview</span>`;
                        }
                        return `
                        <div class="file-item">
                            <div style="display:flex;align-items:center;">
                                ${preview}
                                <div>
                                    <strong>${file.filename}</strong><br>
                                    <small>${(file.size / 1024).toFixed(1)} KB - ${new Date(file.uploadedAt).toLocaleString()}</small>
                                </div>
                            </div>
                            <a href="${fileUrl}" class="download-btn" download>Download</a>
                        </div>
                        `;
                    }).join('');
                    fileListDiv.innerHTML = `
                        ${statusBadge}
                        <h3>Available Files (${session.uploads.length})</h3>
                        ${fileItems}
                        <p><a href="/downloads/${sessionId}" target="_blank">Open in new tab</a></p>
                    `;
                } else {
                    fileListDiv.innerHTML = `${statusBadge}<p>No files found for this session.</p>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
            
            loadBtn.disabled = false;
        }
        
        // Load from URL parameter if present
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            if (sessionId) {
                document.getElementById('session-input').value = sessionId;
                loadSession();
            }
        };
    </script>
</body>
</html>
